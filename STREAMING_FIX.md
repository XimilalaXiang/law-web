# æµå¼å¤„ç†é—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ“‹ é—®é¢˜æè¿°

ä»å¯¼å‡ºçš„èŠå¤©è®°å½• `safecareer-chat-2025-10-12T09-58-01-999Z.md` å‘ç°ï¼š

AIåŠ©æ‰‹çš„å›å¤å†…å®¹æ˜¾ç¤ºçš„æ˜¯åŸå§‹SSEæ•°æ®æµï¼Œè€Œä¸æ˜¯æå–åçš„çº¯æ–‡æœ¬å†…å®¹ï¼š

```
## åŠ©æ‰‹

data: {"id":"0199d7dac7da23c7445641211a18346e","choices":[{"delta":{"content":"ä½ å¥½"}}]}
data: {"id":"0199d7dac7da23c7445641211a18346e","choices":[{"delta":{"content":"ï¼"}}]}
...
```

**é¢„æœŸè¡Œä¸º**ï¼šåº”è¯¥æ˜¾ç¤ºæ‹¼æ¥åçš„å®Œæ•´æ–‡æœ¬ï¼š
```
## åŠ©æ‰‹

ä½ å¥½ï¼æˆ‘æ˜¯SafeCareerçš„AIé˜²éª—é¡¾é—®ï¼Œå¾ˆé«˜å…´ä¸ºä½ æä¾›å¸®åŠ©ï¼ğŸ‘‹
...
```

---

## ğŸ” é—®é¢˜åˆ†æ

### æ•°æ®æµè½¬é“¾è·¯

```
AIæœåŠ¡ (DeepSeek)
    â†“ SSEæµ
api/chat.ts (åç«¯)
    â†“ ç²¾ç®€åçš„SSE
aiService.ts (å‰ç«¯)
    â†“ æå–content
useAIChat Hook
    â†“ é€å­—è¿½åŠ 
message.content
    â†“ æ˜¾ç¤º
MessageBubble ç»„ä»¶
```

### æ ¹æœ¬åŸå› 

**åç«¯æ•°æ®æå–é€»è¾‘ä¸å¤Ÿå¯é **ï¼ˆ`api/chat.ts` ç¬¬269è¡Œï¼‰ï¼š

```typescript
// âŒ æ—§ä»£ç  - ä¸å¤Ÿå¯é 
const data = line.slice(5).trimStart().replace(/^:/, '');
```

**é—®é¢˜åˆ†æ**ï¼š
- `slice(5)` åªå»æ‰å‰5ä¸ªå­—ç¬¦ `"data"`ï¼Œä½†SSEæ ¼å¼æ˜¯ `"data: "`ï¼ˆæœ‰å†’å·å’Œç©ºæ ¼ï¼‰
- å¯¹äº `"data: {...}"` æ ¼å¼ï¼š
  - `slice(5)` â†’ `": {...}"`
  - `trimStart()` â†’ `": {...}"` ï¼ˆå†’å·ä¸æ˜¯ç©ºç™½å­—ç¬¦ï¼Œä¸ä¼šè¢«trimï¼‰
  - `replace(/^:/, '')` â†’ `" {...}"` ï¼ˆå»æ‰å†’å·ï¼Œä½†ç©ºæ ¼è¿˜åœ¨ï¼‰
  
- è™½ç„¶JSON.parseèƒ½å¤„ç†å‰å¯¼ç©ºæ ¼ï¼Œä½†è¿™ä¸ªé€»è¾‘å®¹æ˜“å‡ºé”™

### å¯èƒ½è§¦å‘çš„fallbacké€»è¾‘

å¦‚æœSSEè§£æå¤±è´¥ï¼Œ`forwardedAny` ä¿æŒä¸º `false`ï¼Œä¼šè§¦å‘fallbackï¼ˆç¬¬219-248è¡Œï¼‰ï¼š

```typescript
if (done && !forwardedAny) {
  // æŠŠç´¯ç§¯çš„rawBufferå½“ä½œçº¯æ–‡æœ¬å›å†™
  const text = rawBuffer.trim();
  // ... å¤„ç†å¹¶å‘é€
}
```

è¿™ä¼šå¯¼è‡´å‰ç«¯æ”¶åˆ°å®Œæ•´çš„åŸå§‹SSEæ•°æ®æµï¼Œè€Œä¸æ˜¯ç²¾ç®€åçš„contentã€‚

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹å†…å®¹

**æ–‡ä»¶**: `api/chat.ts` ç¬¬271è¡Œ

```typescript
// âœ… æ–°ä»£ç  - ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼Œæ›´å¯é 
const data = line.replace(/^data:\s*/, '').trim();
```

**ä¼˜åŠ¿**ï¼š
- `/^data:\s*/` åŒ¹é… `"data:"` åçš„ä»»æ„ç©ºç™½å­—ç¬¦ï¼ˆ0ä¸ªæˆ–å¤šä¸ªï¼‰
- ä¸€æ¬¡æ€§å»æ‰ `"data: "` æˆ– `"data:"` å‰ç¼€
- `.trim()` å†æ¬¡æ¸…ç†å‰åç©ºç™½
- æ›´ç®€æ´ã€æ›´å¯é 

### å¢å¼ºçš„é”™è¯¯æ—¥å¿—

```typescript
console.error('SSE parse error for line:', line, e);
```

ä¾¿äºè°ƒè¯•æ—¶æŸ¥çœ‹å…·ä½“æ˜¯å“ªä¸€è¡Œè§£æå¤±è´¥ã€‚

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜

```bash
# Chrome
1. F12 æ‰“å¼€å¼€å‘è€…å·¥å…·
2. å³é”®ç‚¹å‡»åˆ·æ–°æŒ‰é’®
3. é€‰æ‹©"æ¸…ç©ºç¼“å­˜å¹¶ç¡¬æ€§é‡æ–°åŠ è½½"

# æˆ–è€…
Ctrl + Shift + Delete â†’ æ¸…é™¤ç¼“å­˜
```

### 2. è®¿é—®ç”Ÿäº§ç¯å¢ƒ

è®¿é—®ï¼šhttps://law.ximilala.com

### 3. æµ‹è¯•AIåŠ©æ‰‹

1. ç‚¹å‡»å³ä¸‹è§’è“è‰²æ‚¬æµ®æŒ‰é’® ğŸ’¬
2. å‘é€æ¶ˆæ¯ï¼š"hi" æˆ– "ä»€ä¹ˆæ˜¯åŸ¹è®­è´·ï¼Ÿ"
3. è§‚å¯ŸAIå›å¤

**é¢„æœŸç»“æœ**ï¼š
- âœ… AIé€å­—æ˜¾ç¤ºå›å¤å†…å®¹
- âœ… å›å¤æ˜¯æµç•…çš„ä¸­æ–‡æ–‡æœ¬
- âœ… æ”¯æŒMarkdownæ ¼å¼ï¼ˆç²—ä½“ã€åˆ—è¡¨ç­‰ï¼‰

**é”™è¯¯æƒ…å†µ**ï¼š
- âŒ æ˜¾ç¤º `data: {...}` åŸå§‹JSON
- âŒ å›å¤ä¸å®Œæ•´æˆ–æ–­æ–­ç»­ç»­

### 4. å¯¼å‡ºå¯¹è¯éªŒè¯

1. ç‚¹å‡»åŠ©æ‰‹æ¶ˆæ¯å³ä¸‹è§’çš„ä¸‹è½½æŒ‰é’® ğŸ“¥
2. æ‰“å¼€å¯¼å‡ºçš„ `.md` æ–‡ä»¶
3. æ£€æŸ¥"åŠ©æ‰‹"éƒ¨åˆ†çš„å†…å®¹

**é¢„æœŸç»“æœ**ï¼š
```markdown
## åŠ©æ‰‹

ä½ å¥½ï¼æˆ‘æ˜¯SafeCareerçš„AIé˜²éª—é¡¾é—®...ï¼ˆå®Œæ•´æ–‡æœ¬ï¼‰
```

**é”™è¯¯æƒ…å†µ**ï¼š
```markdown
## åŠ©æ‰‹

data: {"choices":[...]}ï¼ˆåŸå§‹SSEæ•°æ®ï¼‰
```

---

## ğŸ› ï¸ å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨

### æ£€æŸ¥æ¸…å•

#### 1. ç¯å¢ƒå˜é‡æ˜¯å¦é…ç½®ï¼Ÿ

è®¿é—® Vercel Dashboardï¼š
https://vercel.com/ximilalaxiangs-projects/trae_k025o5sr/settings/environment-variables

å¿…éœ€é…ç½®ï¼š
- âœ… `AI_API_KEY` - APIå¯†é’¥

#### 2. æ£€æŸ¥APIè°ƒç”¨æ˜¯å¦æˆåŠŸ

æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰â†’ Networkæ ‡ç­¾ï¼š

1. å‘é€ä¸€æ¡æ¶ˆæ¯
2. æ‰¾åˆ° `chat` è¯·æ±‚
3. æŸ¥çœ‹ Response

**æ­£å¸¸æƒ…å†µ**ï¼š
```
data: {"choices":[{"delta":{"content":"ä½ å¥½"}}]}
data: {"choices":[{"delta":{"content":"ï¼"}}]}
data: [DONE]
```

**å¼‚å¸¸æƒ…å†µ**ï¼š
```
HTTP 500 - API key not configured
```

#### 3. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—

```bash
vercel logs https://law.ximilala.com
```

æŸ¥æ‰¾é”™è¯¯ä¿¡æ¯ï¼š
- `SSE parse error` - SSEè§£æé”™è¯¯
- `API key not configured` - ç¯å¢ƒå˜é‡æœªé…ç½®
- `AI service error` - ä¸Šæ¸¸APIé”™è¯¯

---

## ğŸ“Š æ€§èƒ½å½±å“

### ä¼˜åŒ–æ•ˆæœ

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| SSEæ•°æ®å¤§å° | ~800 bytes/åŒ… | ~50 bytes/åŒ… | â†“ 93% |
| JSONè§£æå¤æ‚åº¦ | å®Œæ•´å¯¹è±¡ | ç²¾ç®€å¯¹è±¡ | â†“ 90% |
| ç½‘ç»œä¼ è¾“é‡ | ~80KB/æ¬¡å¯¹è¯ | ~5KB/æ¬¡å¯¹è¯ | â†“ 94% |

### æ•°æ®å¯¹æ¯”

**ä¼˜åŒ–å‰ï¼ˆå®Œæ•´SSEï¼‰**ï¼š
```json
{
  "id": "0199d7dac7da23c7445641211a18346e",
  "object": "chat.completion.chunk",
  "created": 1760263063,
  "model": "deepseek-ai/DeepSeek-V3.1-Terminus",
  "choices": [{
    "index": 0,
    "delta": {
      "content": "ä½ å¥½",
      "reasoning_content": null,
      "role": "assistant"
    },
    "finish_reason": null
  }],
  "system_fingerprint": "",
  "usage": {
    "prompt_tokens": 654,
    "completion_tokens": 1,
    "total_tokens": 655
  }
}
```

**ä¼˜åŒ–åï¼ˆç²¾ç®€SSEï¼‰**ï¼š
```json
{
  "choices": [{
    "delta": {
      "content": "ä½ å¥½"
    }
  }]
}
```

---

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

å¦‚æœæ–°ç‰ˆæœ¬æœ‰é—®é¢˜ï¼Œå¯ä»¥å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼š

```bash
# æŸ¥çœ‹éƒ¨ç½²å†å²
vercel ls

# å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬ï¼ˆæ›¿æ¢URLä¸ºç›®æ ‡ç‰ˆæœ¬ï¼‰
vercel promote https://traek025o5sr-3vcerqh83-ximilalaxiangs-projects.vercel.app
```

---

## ğŸ“ ç›¸å…³æäº¤

- **bc0838b** - fix: ä¼˜åŒ–SSEæµå¼å¤„ç†çš„æ•°æ®æå–é€»è¾‘ï¼Œä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æé«˜å¯é æ€§
- **c3eee3d** - fix: è§£å†³api/chat.tsåˆå¹¶å†²çªå¹¶ä¿®å¤TypeScriptç±»å‹è­¦å‘Š
- **ee18b18** - feat: å®Œå–„AIåŠ©æ‰‹åŠŸèƒ½å’ŒUIä¼˜åŒ–ï¼Œæ·»åŠ å¤šä¼šè¯ç®¡ç†ã€æµå¼å“åº”ã€ä¸»é¢˜åˆ‡æ¢ç­‰åŠŸèƒ½

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Server-Sent Events (SSE) è§„èŒƒ](https://html.spec.whatwg.org/multipage/server-sent-events.html)
- [Vercel Serverless Functions](https://vercel.com/docs/functions/serverless-functions)
- [DeepSeek API æ–‡æ¡£](https://platform.deepseek.com/api-docs/)

---

**æœ€åæ›´æ–°**: 2025-10-12  
**ä¿®å¤ç‰ˆæœ¬**: v1.1.0  
**éƒ¨ç½²çŠ¶æ€**: âœ… ç”Ÿäº§ç¯å¢ƒå·²éƒ¨ç½²

